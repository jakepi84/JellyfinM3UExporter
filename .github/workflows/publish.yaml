name: 'Publish Plugin'

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build and release (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    # Skip if the commit is from github-actions bot
    if: "!contains(github.event.head_commit.message, '[skip ci]') && github.actor != 'github-actions[bot]'"
    permissions:
      contents: write
    
    steps:
      - name: Determine Tag
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG="${{ github.event.inputs.tag }}"
            # Validate tag format (should start with 'v' followed by version number)
            # Allows suffixes with alphanumeric characters, dots, and hyphens only
            if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
              echo "Error: Invalid tag format. Tag must match pattern 'vX.Y.Z' or 'vX.Y.Z-suffix'"
              echo "Examples: v1.0.0, v2.1.3, v1.0.0-beta, v1.0.0-rc.1"
              exit 1
            fi
            echo "name=$TAG" >> $GITHUB_OUTPUT
          else
            echo "name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.tag.outputs.name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
    
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq xmlstarlet
          # Install yq for robust YAML parsing (pinned version for security)
          YQ_VERSION="v4.40.5"
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq

      - name: Extract version from Directory.Build.props
        id: get_version
        run: |
          VERSION=$(xmlstarlet sel -t -v "//Version" Directory.Build.props)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          # Extract X.Y.Z from X.Y.Z.W format
          TAG="v$(echo $VERSION | cut -d. -f1-3)"
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
          echo "Tag will be: $TAG"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore -p:TreatWarningsAsErrors=false

      - name: Create plugin package
        run: |
          mkdir -p artifacts/m3u-exporter
          cp Jellyfin.Plugin.M3UExporter/bin/Release/net9.0/Jellyfin.Plugin.M3UExporter.dll artifacts/m3u-exporter/
          # Set deterministic timestamps for reproducible builds (Unix epoch)
          find artifacts/m3u-exporter -exec touch -d '1970-01-01 00:00:00 UTC' {} +
          cd artifacts
          zip -r -X "m3u-exporter_${{ steps.get_version.outputs.VERSION }}.zip" m3u-exporter

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jellyfin-plugin-m3uexporter
          path: artifacts/m3u-exporter_${{ steps.get_version.outputs.VERSION }}.zip

      - name: Update manifest.json
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          ./update-manifest.sh "${{ steps.get_version.outputs.VERSION }}" "artifacts/m3u-exporter_${{ steps.get_version.outputs.VERSION }}.zip"

      - name: Commit updated manifest
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Fetch and checkout main branch
          git fetch origin main
          git checkout main
          
          # Copy the updated manifest from the tag checkout
          cp manifest.json manifest.json.new
          git checkout manifest.json
          mv manifest.json.new manifest.json
          
          git add manifest.json
          if ! git diff --staged --quiet; then
            git commit -m "Update manifest.json for version ${{ steps.get_version.outputs.VERSION }} [skip ci]"
            git push origin main
          fi

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.TAG }}
          name: Release ${{ steps.get_version.outputs.TAG }}
          draft: false
          prerelease: false
          make_latest: true
          fail_on_unmatched_files: true
          files: artifacts/m3u-exporter_${{ steps.get_version.outputs.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
